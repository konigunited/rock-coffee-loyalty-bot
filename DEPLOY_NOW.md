# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å–µ—Ä–≤–µ—Ä (Ubuntu + Docker)

## ‚ö†Ô∏è –í–∞–∂–Ω–æ: –ø—Ä–æ–µ–∫—Ç —É–∂–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
- –î–∞—É–Ω—Ç–∞–π–º –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ~5‚Äì10 —Å–µ–∫—É–Ω–¥
- –ë—ç–∫–∞–ø –ë–î –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
- –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ **–Ω–µ –º–µ–Ω—è–µ—Ç** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–æ–≤

## ‚úÖ –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è —Å –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è (10 –±–∞–ª–ª–æ–≤ + —Å–æ–æ–±—â–µ–Ω–∏–µ)
- –°–µ—Ä–≤–∏—Å `BirthdayService`, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞—Ä—Ç—É–µ—Ç –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –±–æ—Ç–æ–º
- –ú–∏–≥—Ä–∞—Ü–∏—è `008_add_last_birthday_bonus.sql` —Å –∫–æ–ª–æ–Ω–∫–æ–π `last_birthday_bonus_at`

## üóÇ –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
| –§–∞–π–ª | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
| --- | --- |
| `src/services/birthday.service.ts` | –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 09:00 (–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–æ–≤, –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–æ–Ω—É—Å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ |
| `src/index.ts` | –í–∫–ª—é—á–∞–µ—Ç –∑–∞–ø—É—Å–∫ –∏ –ø–ª–∞–≤–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É `BirthdayService` |
| `migrations/008_add_last_birthday_bonus.sql` | –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É `last_birthday_bonus_at` –∏ –∏–Ω–¥–µ–∫—Å |
| `SAFE_DEPLOY_COMMANDS.md` | –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞ –∫–æ–º–∞–Ω–¥–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–¥–µ—Ä–∂–∏ –ø–æ–¥ —Ä—É–∫–æ–π –ø—Ä–∏ –¥–µ–ø–ª–æ–µ) |

---

## üõ°Ô∏è –ü–æ—à–∞–≥–æ–≤—ã–π –¥–µ–ø–ª–æ–π –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞

### –®–∞–≥ 0. –ü–µ—Ä–µ–¥ –≤—ã–µ–∑–¥–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
```bash
# –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
git status

# –û—Ç–ø—Ä–∞–≤—å –∫–æ–º–º–∏—Ç –≤ origin
git push origin main

# –£–±–µ–¥–∏—Å—å, —á—Ç–æ origin/main —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–≤–æ–π –∫–æ–º–º–∏—Ç
git log origin/main -1
```
–ü—Ä–æ–¥–æ–ª–∂–∞–π —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ `git push` –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ `origin/main`, —á—Ç–æ–±—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ–¥—Ç—è–Ω—É–ª–∞—Å—å –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–æ—Ç–∞.

### –®–∞–≥ 1. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∏ –ø—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
```bash
ssh your_user@your_server_ip
cd /path/to/rc_bot
docker-compose ps
```
–û–∂–∏–¥–∞–µ–º `rock_coffee_bot` –∏ `rock_coffee_db` –≤ —Å—Ç–∞—Ç—É—Å–µ `Up`.

### –®–∞–≥ 2. –°–¥–µ–ª–∞–π –±—ç–∫–∞–ø –±–∞–∑—ã
```bash
docker exec rock_coffee_db pg_dump -U postgres rock_coffee_bot > backup_$(date +%Y%m%d_%H%M%S).sql
ls -lh backup_*.sql | tail -1
```
–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 10 KB.

### –®–∞–≥ 3. –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π —Ç–µ–∫—É—â–∏–π commit –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–∫–∞—Ç–∞
```bash
git log --oneline -1
```
–°–æ—Ö—Ä–∞–Ω–∏ hash.

### –®–∞–≥ 4. –ó–∞–±–µ—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
```bash
git pull origin main
```
–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å —Ñ–∞–π–ª—ã:
- `migrations/008_add_last_birthday_bonus.sql`
- `src/services/birthday.service.ts`
- `src/index.ts`
- `SAFE_DEPLOY_COMMANDS.md`

### –®–∞–≥ 5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é (–±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
```bash
docker cp migrations/008_add_last_birthday_bonus.sql rock_coffee_db:/tmp/
docker exec -it rock_coffee_db psql -U postgres -d rock_coffee_bot -f /tmp/008_add_last_birthday_bonus.sql
docker exec -it rock_coffee_db psql -U postgres -d rock_coffee_bot -c "\d+ clients" | grep last_birthday_bonus_at
```
–û–∂–∏–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É `last_birthday_bonus_at | timestamp with time zone |`.

### –®–∞–≥ 6. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏ –æ–±—Ä–∞–∑ –±–æ—Ç–∞ (–±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è)
```bash
docker-compose build bot
```
–°–±–æ—Ä–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 30‚Äì60 —Å–µ–∫—É–Ω–¥, —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –±–æ—Ç–∞ –≤ —ç—Ç–æ –≤—Ä–µ–º—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

### –®–∞–≥ 7. –ë—ã—Å—Ç—Ä—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç –±–æ—Ç–∞
```bash
docker-compose up -d bot
```
–î–∞—É–Ω—Ç–∞–π–º ~5‚Äì10 —Å–µ–∫—É–Ω–¥, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.

### –®–∞–≥ 8. –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫)
docker-compose logs --tail=40 bot

# –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
curl http://localhost:3000/health

# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ BirthdayService –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
docker-compose logs --tail=40 bot | grep BirthdayService || true

# –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose ps
```
Health endpoint –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `{"status":"ok", ...}`.

### –®–∞–≥ 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Telegram
1. –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å `/start`
2. –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á–µ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏: –ø–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞, –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤, —Ä–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ—Ç–≤–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫

---

## üö® –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è

### –í–∞—Ä–∏–∞–Ω—Ç 1. –û—Ç–∫–∞—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–¥ (–ë–î –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–æ–≤–æ–π)
```bash
git log --oneline -5
git checkout <PREV_HASH>
docker-compose build bot
docker-compose up -d bot
```

### –í–∞—Ä–∏–∞–Ω—Ç 2. –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç –≤–º–µ—Å—Ç–µ —Å –ë–î
```bash
docker-compose stop bot
ls -lh backup_*.sql | tail -1
cat backup_YYYYMMDD_HHMMSS.sql | docker exec -i rock_coffee_db psql -U postgres -d rock_coffee_bot
git checkout <PREV_HASH>
docker-compose build bot
docker-compose up -d bot
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
- [ ] –°–¥–µ–ª–∞–Ω –±—ç–∫–∞–ø –ë–î –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω —Ä–∞–∑–º–µ—Ä
- [ ] –°–æ—Ö—Ä–∞–Ω—ë–Ω hash —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω `git pull origin main`
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è 008 –ø—Ä–∏–º–µ–Ω–µ–Ω–∞, –∫–æ–ª–æ–Ω–∫–∞ –≤–∏–¥–Ω–∞ –≤ `\d+ clients`
- [ ] –û–±—Ä–∞–∑ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω: `docker-compose build bot`
- [ ] –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω: `docker-compose up -d bot`
- [ ] `curl /health` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `status: ok`
- [ ] –í –ª–æ–≥–∞—Ö –Ω–µ—Ç –æ—à–∏–±–æ–∫, `BirthdayService` —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª
- [ ] –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –≤ Telegram –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

---

## üéØ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –ö–ª–∏–µ–Ω—Ç—ã —Å –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç +10 –±–∞–ª–ª–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ù–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è —á–∞—â–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞ –≤ 10 –º–µ—Å—è—Ü–µ–≤ (–∫–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–ª–æ–Ω–∫–æ–π)
- –ë–∞–ª–∞–Ω—Å –∏ –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ä—É—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

**–ì–æ—Ç–æ–≤–æ!** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤. üéâ

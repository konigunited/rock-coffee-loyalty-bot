# 🚀 Пошаговая инструкция по развертыванию

Подробная инструкция для развертывания Telegram-бота системы лояльности с нуля.

## 📋 Подготовка

### Шаг 1: Системные требования
- ✅ Python 3.8+
- ✅ Стабильное интернет-соединение
- ✅ Telegram аккаунт
- ✅ Google аккаунт

### Шаг 2: Скачивание проекта
```bash
# Скачайте архив проекта и распакуйте
cd путь/к/проекту/rc_bot
```

## 🤖 Создание Telegram бота

### Шаг 3: Регистрация бота
1. Откройте Telegram
2. Найдите бота [@BotFather](https://t.me/BotFather)
3. Отправьте команду `/start`
4. Отправьте команду `/newbot`
5. Введите имя бота (например: "Loyalty System Bot")
6. Введите username бота (например: "my_loyalty_bot")
7. **Сохраните полученный токен!** Выглядит как: `1234567890:ABCdefGHIjklMNOpqrSTUvwxYZ`

### Шаг 4: Настройка бота
Отправьте боту @BotFather команды:
```
/setdescription
Система лояльности с QR-кодами и бонусными баллами

/setabouttext
Бот для управления программой лояльности

/setcommands
start - Начать работу
balance - Проверить баланс
qr - Получить QR-код
```

## 📊 Настройка Google Sheets

### Шаг 5: Создание Google Cloud проекта

#### 5.1: Создание проекта
1. Перейдите на [Google Cloud Console](https://console.cloud.google.com/)
2. Нажмите на выпадающий список проектов (вверху справа)
3. Нажмите "New Project"
4. Введите название: "Loyalty Bot Project"
5. Нажмите "Create"

#### 5.2: Включение API
1. В левом меню выберите "APIs & Services" → "Library"
2. Найдите "Google Sheets API"
3. Нажмите на него и нажмите "Enable"
4. Найдите "Google Drive API" 
5. Нажмите на него и нажмите "Enable"

### Шаг 6: Создание Service Account

#### 6.1: Создание аккаунта
1. Перейдите в "IAM & Admin" → "Service Accounts"
2. Нажмите "Create Service Account"
3. Заполните поля:
   - **Service account name**: `loyalty-bot`
   - **Service account ID**: `loyalty-bot` (заполнится автоматически)
   - **Description**: `Service account for Telegram loyalty bot`
4. Нажмите "Create and Continue"
5. Пропустите role assignment (нажмите "Continue")
6. Нажмите "Done"

#### 6.2: Создание ключа
1. Найдите созданный Service Account в списке
2. Нажмите на него
3. Перейдите на вкладку "Keys"
4. Нажмите "Add Key" → "Create New Key"
5. Выберите тип "JSON"
6. Нажмите "Create"
7. **Файл JSON скачается автоматически** - сохраните его!

### Шаг 7: Подготовка credentials.json

1. Переименуйте скачанный файл в `credentials.json`
2. Поместите файл в корневую папку проекта `rc_bot/`
3. Откройте файл и найдите поле `"client_email"` (понадобится на следующем шаге)

### Шаг 8: Создание Google Таблицы

#### 8.1: Создание таблицы
1. Откройте [Google Sheets](https://sheets.google.com/)
2. Нажмите "+" для создания новой таблицы
3. Переименуйте таблицу:c 
#### 8.2: Настройка доступа
1. Нажмите кнопку "Share" (Поделиться) в правом верхнем углу
2. В поле "Add people and groups" вставьте email из `client_email` (из credentials.json)
3. Выберите роль "Editor" 
4. Снимите галочку "Notify people" (не нужно отправлять уведомление)
5. Нажмите "Share"

#### 8.3: Получение ID таблицы
Скопируйте ID из URL таблицы:
```
https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                                   Это ID таблицы - скопируйте его!
```

## ⚙️ Настройка проекта

### Шаг 9: Установка зависимостей
```bash
# Перейдите в папку проекта
cd rc_bot

# Установите зависимости Python
pip install -r requirements.txt
```

### Шаг 10: Создание конфигурации

#### 10.1: Создание .env файла
```bash
# Скопируйте пример конфигурации
cp .env.example .env

# Откройте файл для редактирования
# Windows: notepad .env
# Mac/Linux: nano .env
```

#### 10.2: Заполнение параметров
Откройте файл `.env` и заполните все параметры:

```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=ВСТАВЬТЕ_ТОКЕН_БОТА_СЮДА
TELEGRAM_ADMIN_ID=ВАШ_TELEGRAM_ID

# Google Sheets Configuration  
GOOGLE_SHEETS_ID=ID_GOOGLE_ТАБЛИЦЫ_СЮДА
GOOGLE_CREDENTIALS_FILE=credentials.json

# Bot Configuration
BOT_TIMEZONE=Europe/Moscow
BIRTHDAY_BONUS_AMOUNT=500
REGISTRATION_BONUS_AMOUNT=100
LOG_LEVEL=INFO
```

### Шаг 11: Получение вашего Telegram ID

#### 11.1: Через специального бота
1. Найдите бота [@userinfobot](https://t.me/userinfobot)
2. Отправьте ему команду `/start`
3. Скопируйте ваш ID из ответа
4. Вставьте в параметр `TELEGRAM_ADMIN_ID`

#### 11.2: Альтернативный способ
1. Найдите бота [@myidbot](https://t.me/myidbot)  
2. Отправьте `/getid`
3. Скопируйте полученный ID

## 🧪 Тестирование настройки

### Шаг 12: Проверка конфигурации

#### 12.1: Проверка файлов
Убедитесь что в папке `rc_bot/` есть:
```
rc_bot/
├── main.py                ✅
├── requirements.txt       ✅
├── .env                  ✅ (создали)
├── credentials.json      ✅ (скачали)
└── src/                  ✅
```

#### 12.2: Проверка .env файла
Откройте `.env` и убедитесь что все поля заполнены (не должно быть `YOUR_*_HERE`):
```env
TELEGRAM_BOT_TOKEN=1234567890:ABCdef... ✅ (длинная строка)
TELEGRAM_ADMIN_ID=123456789              ✅ (ваш ID)
GOOGLE_SHEETS_ID=1BxiMVs0XRA5n...       ✅ (ID таблицы)
GOOGLE_CREDENTIALS_FILE=credentials.json ✅
```

### Шаг 13: Первый запуск

#### 13.1: Запуск в тестовом режиме
```bash
# Запустите бота
python main.py
```

#### 13.2: Ожидаемый результат
Вы должны увидеть:
```
╔══════════════════════════════════════════════════════════════╗
║                    TELEGRAM LOYALTY BOT                      ║
║                     Система лояльности                       ║
╚══════════════════════════════════════════════════════════════╝

2024-01-15 10:30:00 - INFO - Бот настроен и готов к работе
2024-01-15 10:30:01 - INFO - Успешно подключились к Google Sheets  
2024-01-15 10:30:02 - INFO - Планировщик birthday-бонусов запущен
2024-01-15 10:30:03 - INFO - Бот успешно запущен!
```

### Шаг 14: Проверка работы

#### 14.1: Тест Telegram бота
1. Найдите вашего бота в Telegram (по username)
2. Отправьте команду `/start`
3. Бот должен ответить приветственным сообщением

#### 14.2: Тест Google Sheets
1. Откройте вашу Google Таблицу
2. Должны появиться новые листы:
   - "Клиенты"
   - "Сотрудники"  
   - "Настройки"

#### 14.3: Тест административных функций
1. Отправьте боту `/admin`
2. Должно появиться меню администратора

Если все работает - поздравляем! 🎉

## 🚀 Продуктивное развертывание

### Шаг 15: Настройка для продакшена

#### 15.1: Обновление настроек
В файле `.env` измените:
```env
LOG_LEVEL=WARNING  # Меньше логов в продакшене
```

#### 15.2: Запуск в фоне (Linux/Mac)
```bash
# Создайте скрипт запуска
cat > start_bot.sh << EOF
#!/bin/bash
cd $(dirname $0)
nohup python main.py > bot_output.log 2>&1 &
echo \$! > bot.pid
echo "Bot started with PID: \$(cat bot.pid)"
EOF

chmod +x start_bot.sh
./start_bot.sh
```

#### 15.3: Остановка бота
```bash
# Создайте скрипт остановки
cat > stop_bot.sh << EOF
#!/bin/bash
if [ -f bot.pid ]; then
    kill \$(cat bot.pid)
    rm bot.pid
    echo "Bot stopped"
else
    echo "Bot PID file not found"
fi
EOF

chmod +x stop_bot.sh
```

### Шаг 16: Создание первого сотрудника

#### 16.1: Добавление через админ-панель
1. Отправьте боту `/admin`
2. Выберите "👨‍💼 Управление персоналом"
3. Нажмите "➕ Добавить сотрудника"
4. Следуйте инструкциям бота

#### 16.2: Получение Telegram ID сотрудника
Сотрудник должен:
1. Написать боту [@userinfobot](https://t.me/userinfobot)
2. Отправить полученный ID администратору

## 📋 Checklist готовности

Перед запуском в работу убедитесь:

### Telegram
- [ ] Бот создан через @BotFather
- [ ] Токен бота добавлен в .env
- [ ] Бот отвечает на команду /start
- [ ] Админ-панель доступна через /admin

### Google Sheets
- [ ] Проект создан в Google Cloud Console
- [ ] Google Sheets API включен
- [ ] Service Account создан
- [ ] Credentials.json скачан и размещен
- [ ] Таблица создана и расшарена
- [ ] ID таблицы добавлен в .env
- [ ] Листы создаются автоматически

### Система
- [ ] Python 3.8+ установлен
- [ ] Все зависимости установлены
- [ ] .env файл заполнен
- [ ] Логи записываются
- [ ] Планировщик запущен
- [ ] QR-коды генерируются

### Функционал
- [ ] Регистрация клиентов работает
- [ ] Начисление/списание баллов работает
- [ ] Статистика отображается
- [ ] Birthday-бонусы настроены
- [ ] Поиск клиентов работает

## 🆘 Что делать если что-то не работает

### Проблема: Бот не отвечает
```bash
# Проверьте логи
tail -f logs/bot.log

# Проверьте что бот запущен
ps aux | grep python

# Перезапустите бота
python main.py
```

### Проблема: Ошибки Google Sheets
1. Проверьте права доступа к таблице
2. Убедитесь что API включены
3. Проверьте credentials.json

### Проблема: Команды не работают
1. Проверьте роль пользователя
2. Убедитесь что пользователь добавлен как сотрудник
3. Проверьте логи на ошибки авторизации

## 📞 Поддержка

После завершения настройки у вас должна быть полностью рабочая система лояльности!

**Важно**: Сделайте резервную копию файлов `.env` и `credentials.json` в безопасном месте.

---
✅ **Развертывание завершено! Система готова к работе!** ✅